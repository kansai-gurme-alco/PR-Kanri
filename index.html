<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PR管理 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        :root {
            --glass-bg: rgba(255, 255, 255, 0.9);
            --accent: #ff4757;
        }

        /* 画面全体の固定：左右の揺れを完全に防止 */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            position: fixed;
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
                        url('https://images.unsplash.com/photo-1555939594-58d7cb561ad1?auto=format&fit=crop&w=1000&q=80');
            background-size: cover;
            background-position: center;
            overscroll-behavior: none; 
            -webkit-overflow-scrolling: touch;
        }

        .app-shell {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        /* メインスクロールエリア */
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            padding-bottom: 180px; 
            overscroll-behavior-y: contain;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        /* Source Badge Colors */
        .source-insta { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; }
        .source-tiktok { background: #00f2ea; color: #000; }
        .source-unit { background: #ffcc00; color: #000; }
        .source-toridori { background: linear-gradient(to right, #ff4e50, #f9d423, #00f2ea, #bc1888); color: white; }
        .source-other { background: #e2e8f0; color: #475569; }

        /* Status Pills */
        .status-pill { font-size: 0.65rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; white-space: nowrap; }
        .status-negotiating { background: #fff3bf; color: #947600; }
        .status-adjusting { background: #e3f2fd; color: #1976d2; }
        .status-upcoming { background: #e8f5e9; color: #2e7d32; }
        .status-completed { background: #f1f3f5; color: #495057; }
        .status-failed { background: #343a40; color: #f8f9fa; }

        .tab-active { color: var(--accent) !important; background: rgba(255, 71, 87, 0.05); border-radius: 16px; }

        .fab {
            position: absolute;
            bottom: 115px; 
            right: 20px;
            z-index: 45;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }

        /* ナビゲーションバー */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            padding-top: 12px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 50;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 55px;
            transition: all 0.2s;
            color: #94a3b8;
        }

        .status-filter-btn {
            font-size: 0.75rem;
            padding: 8px 16px;
            border-radius: 12px;
            white-space: nowrap;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .status-filter-btn.active { background: white; color: black; font-weight: bold; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Modal */
        .modal-container {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .modal-body {
            width: 100%;
            max-width: 500px;
            max-height: 92vh;
            background: white;
            border-radius: 32px 32px 0 0;
            position: relative;
            z-index: 110;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .checkbox-group label {
            transition: all 0.2s;
            border: 1px solid #f3f4f6;
        }
        .checkbox-group input:checked + span {
            color: #ff4757;
            font-weight: bold;
        }
        .checkbox-group label:has(input:checked) {
            background-color: #fff1f2;
            border-color: #fecaca;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- Header -->
        <header class="p-4 pt-8 pb-2 shrink-0">
            <h1 class="text-white text-3xl font-bold tracking-tight">PR管理</h1>
            <p class="text-white/60 text-xs mt-1">案件・実績・スケジュール</p>
        </header>

        <!-- Main Scrollable Area -->
        <div class="scroll-content no-scrollbar">
            <!-- View: Dashboard -->
            <section id="view-dashboard" class="view space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <div class="glass-card p-3 text-center">
                        <span class="block text-[9px] font-bold text-gray-400 uppercase">進行中</span>
                        <span id="stat-active" class="text-xl font-bold text-red-500">0</span>
                    </div>
                    <div class="glass-card p-3 text-center">
                        <span class="block text-[9px] font-bold text-gray-400 uppercase">完了済</span>
                        <span id="stat-completed" class="text-xl font-bold text-slate-800">0</span>
                    </div>
                    <div class="glass-card p-3 text-center">
                        <span class="block text-[9px] font-bold text-gray-400 uppercase">全案件数</span>
                        <span id="stat-total" class="text-xl font-bold text-blue-500">0</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <h2 class="text-white text-lg font-bold px-1">直近の予定</h2>
                    <div id="upcoming-list" class="space-y-4"></div>
                </div>
            </section>

            <!-- View: Calendar -->
            <section id="view-calendar" class="view hidden space-y-4">
                <div class="glass-card p-5">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="changeMonth(-1)" class="p-2"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-400"></i></button>
                        <h3 id="calendar-title" class="font-bold text-gray-800">2024年 10月</h3>
                        <button onclick="changeMonth(1)" class="p-2"><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center mb-3">
                        <div class="text-[10px] text-red-400 font-bold">日</div>
                        <div class="text-[10px] text-gray-400">月</div>
                        <div class="text-[10px] text-gray-400">火</div>
                        <div class="text-[10px] text-gray-400">水</div>
                        <div class="text-[10px] text-gray-400">木</div>
                        <div class="text-[10px] text-gray-400">金</div>
                        <div class="text-[10px] text-blue-400 font-bold">土</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
                <div id="calendar-day-details" class="space-y-3"></div>
            </section>

            <!-- View: List -->
            <section id="view-list" class="view hidden space-y-4">
                <div class="space-y-4">
                    <div class="relative">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-white/60"></i>
                        <input type="text" id="search-input" oninput="renderList()" placeholder="店舗名で検索..." class="w-full text-sm pl-10 pr-4 py-3 rounded-2xl bg-white/20 text-white placeholder-white/60 outline-none backdrop-blur-md">
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        <button onclick="filterByStatus('all')" id="filter-all" class="status-filter-btn active">すべて</button>
                        <button onclick="filterByStatus('negotiating')" id="filter-negotiating" class="status-filter-btn">交渉中</button>
                        <button onclick="filterByStatus('upcoming')" id="filter-upcoming" class="status-filter-btn">予定</button>
                        <button onclick="filterByStatus('completed')" id="filter-completed" class="status-filter-btn">完了</button>
                        <button onclick="filterByStatus('deleted')" id="filter-deleted" class="status-filter-btn flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> ゴミ箱</button>
                    </div>
                </div>
                <div id="full-archive" class="space-y-3"></div>
            </section>
        </div>

        <!-- FAB -->
        <button onclick="openModal()" class="fab bg-red-500 text-white w-14 h-14 rounded-full flex items-center justify-center transition-transform active:scale-95 shadow-xl">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button onclick="switchTab('dashboard')" class="nav-item" id="nav-dashboard">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold mt-1">ホーム</span>
            </button>
            <button onclick="switchTab('calendar')" class="nav-item" id="nav-calendar">
                <i data-lucide="calendar" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold mt-1">予定表</span>
            </button>
            <button onclick="switchTab('list')" class="nav-item" id="nav-list">
                <i data-lucide="layers" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold mt-1">リスト</span>
            </button>
        </nav>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal-container hidden">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-body no-scrollbar">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto my-4 shrink-0"></div>
            <form id="pr-form" class="p-6 space-y-6">
                <input type="hidden" id="edit-id">
                <h2 class="text-xl font-bold text-gray-800" id="modal-title">案件登録</h2>
                
                <div class="space-y-6">
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">店舗名 *</label>
                            <input type="text" id="shop-name" required class="w-full p-4 bg-gray-50 rounded-xl outline-none ring-1 ring-gray-100 focus:ring-red-400">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">ステータス</label>
                                <select id="status" class="w-full p-4 bg-gray-50 rounded-xl outline-none ring-1 ring-gray-100">
                                    <option value="negotiating">交渉中</option>
                                    <option value="adjusting">日程調整</option>
                                    <option value="upcoming">来店予定</option>
                                    <option value="completed">完了</option>
                                    <option value="failed">頓挫</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">来店日時</label>
                                <input type="datetime-local" id="visit-date" class="w-full p-4 bg-gray-50 rounded-xl outline-none ring-1 ring-gray-100">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">依頼媒体</label>
                            <select id="source" class="w-full p-4 bg-gray-50 rounded-xl outline-none ring-1 ring-gray-100">
                                <option value="Instagram">Instagram</option>
                                <option value="TikTok">TikTok</option>
                                <option value="ユニット">ユニット</option>
                                <option value="トリドリ">トリドリ</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>

                    <!-- 依頼内容 (TODO) -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">依頼内容（TODO）</label>
                        <div class="grid grid-cols-2 gap-2 checkbox-group">
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="feed" class="accent-red-500"> <span class="text-[11px]">フィード</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="reels" class="accent-red-500"> <span class="text-[11px]">リール</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="google" class="accent-red-500"> <span class="text-[11px]">Google</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="tieup" class="accent-red-500"> <span class="text-[11px]">タイアップ</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="insight" class="accent-red-500"> <span class="text-[11px]">インサイト</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="tabelog" class="accent-red-500"> <span class="text-[11px]">食べログ</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="link" class="accent-red-500"> <span class="text-[11px]">リンク</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="todo" value="hashtag" class="accent-red-500"> <span class="text-[11px]">タグ</span>
                            </label>
                        </div>
                    </div>

                    <!-- 条件 -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">条件</label>
                        <div class="grid grid-cols-2 gap-2 checkbox-group">
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="free_eat" class="accent-red-500"> <span class="text-[11px]">飲食自由</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="course" class="accent-red-500"> <span class="text-[11px]">コース</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="food_spec" class="accent-red-500"> <span class="text-[11px]">料理指定</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="drink_spec" class="accent-red-500"> <span class="text-[11px]">ドリンク指定</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="plus1" class="accent-red-500"> <span class="text-[11px]">同伴1名</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="plus2" class="accent-red-500"> <span class="text-[11px]">同伴2名以上</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="free" class="accent-red-500"> <span class="text-[11px]">無償</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                                <input type="checkbox" name="condition" value="paid" class="accent-red-500"> <span class="text-[11px]">有償</span>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">備考</label>
                        <textarea id="notes" class="w-full p-4 bg-gray-50 rounded-xl outline-none ring-1 ring-gray-100 h-24"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 pt-6 pb-12">
                    <button type="button" onclick="deleteToTrash()" id="delete-btn" class="hidden flex-shrink-0 w-14 h-14 bg-gray-100 text-gray-400 rounded-xl flex items-center justify-center">
                        <i data-lucide="trash-2"></i>
                    </button>
                    <button type="button" onclick="restoreFromTrash()" id="restore-btn" class="hidden flex-shrink-0 w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center">
                        <i data-lucide="refresh-ccw"></i>
                    </button>
                    <button type="submit" class="flex-grow bg-gray-900 text-white font-bold h-14 rounded-xl">保存する</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let projects = JSON.parse(localStorage.getItem('pr_manager_v8') || '[]');
        let deletedProjects = JSON.parse(localStorage.getItem('pr_manager_deleted_v8') || '[]');
        let currentMonth = new Date();
        let currentFilter = 'all';

        const TODO_LABELS = { 
            feed: 'フィード', reels: 'リール', insight: 'インサイト', google: 'Google', 
            tieup: 'タイアップ', tabelog: '食べログ', link: 'リンク', hashtag: 'タグ' 
        };
        const CONDITION_LABELS = { 
            free_eat: '飲食自由', course: 'コース', food_spec: '料理指定', drink_spec: 'ドリンク指定', 
            plus1: '同伴1名', plus2: '同伴2名以上', free: '無償', paid: '有償' 
        };
        const STATUS_MAP = {
            negotiating: { label: '交渉中', class: 'status-negotiating' },
            adjusting: { label: '日程調整', class: 'status-adjusting' },
            upcoming: { label: '来店予定', class: 'status-upcoming' },
            completed: { label: '完了', class: 'status-completed' },
            failed: { label: '頓挫', class: 'status-failed' }
        };

        window.onload = () => {
            renderAll();
            switchTab('dashboard');
        };

        function saveData() {
            localStorage.setItem('pr_manager_v8', JSON.stringify(projects));
            localStorage.setItem('pr_manager_deleted_v8', JSON.stringify(deletedProjects));
            renderAll();
        }

        function renderAll() {
            updateStats();
            renderUpcoming();
            renderCalendar();
            renderList();
            lucide.createIcons();
        }

        function updateStats() {
            const activeCount = projects.filter(p => p.status !== 'completed' && p.status !== 'failed').length;
            const completedCount = projects.filter(p => p.status === 'completed').length;
            document.getElementById('stat-active').innerText = activeCount;
            document.getElementById('stat-completed').innerText = completedCount;
            document.getElementById('stat-total').innerText = projects.length; // 進行中+完了の合計値
        }

        function switchTab(tab) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`nav-${tab}`).classList.add('tab-active');
            document.querySelector('.scroll-content').scrollTo(0,0);
        }

        function filterByStatus(status) {
            currentFilter = status;
            document.querySelectorAll('.status-filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`filter-${status}`).classList.add('active');
            renderList();
        }

        function getSourceClass(source) {
            const map = { 'Instagram': 'source-insta', 'TikTok': 'source-tiktok', 'ユニット': 'source-unit', 'トリドリ': 'source-toridori' };
            return map[source] || 'source-other';
        }

        // リストをソートする共通関数 (未来の日付が上、日付なしは下)
        function sortProjects(list) {
            return list.sort((a, b) => {
                if (!a.visitDate && !b.visitDate) return 0;
                if (!a.visitDate) return 1;
                if (!b.visitDate) return -1;
                return new Date(b.visitDate) - new Date(a.visitDate); // 未来が上
            });
        }

        function renderUpcoming() {
            const container = document.getElementById('upcoming-list');
            const now = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(now.getDate() + 7);

            // 近日予定は日付が近い順（昇順）
            const upcoming = projects
                .filter(p => p.visitDate && new Date(p.visitDate) >= now && new Date(p.visitDate) <= nextWeek && p.status !== 'completed' && p.status !== 'failed')
                .sort((a,b) => new Date(a.visitDate) - new Date(b.visitDate));

            if (upcoming.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-white/40 text-xs italic">1週間以内の予定はありません</div>`;
                return;
            }

            container.innerHTML = upcoming.map(p => {
                const d = new Date(p.visitDate);
                return `
                    <div class="glass-card p-5" onclick="editProject('${p.id}')">
                        <div class="flex justify-between items-start">
                            <div class="max-w-[70%]">
                                <h3 class="font-bold text-gray-800 text-sm truncate">${p.shopName}</h3>
                                <p class="text-[10px] text-red-500 font-bold mt-1">${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</p>
                            </div>
                            <span class="status-pill ${STATUS_MAP[p.status].class}">${STATUS_MAP[p.status].label}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderList() {
            const container = document.getElementById('full-archive');
            const search = document.getElementById('search-input').value.toLowerCase();
            let list = currentFilter === 'deleted' ? [...deletedProjects] : [...projects];
            
            // 検索とフィルタリング
            let filtered = list.filter(p => p.shopName.toLowerCase().includes(search));
            if (currentFilter !== 'all' && currentFilter !== 'deleted') filtered = filtered.filter(p => p.status === currentFilter);

            // 並び順：未来の日付が上（降順）
            const sorted = sortProjects(filtered);

            container.innerHTML = sorted.map(p => {
                const visitLabel = p.visitDate ? 
                    `<p class="text-[9px] text-gray-400 mt-1 font-semibold">${p.visitDate.replace('T', ' ')}</p>` : '';
                
                return `
                <div class="glass-card p-4 flex flex-col gap-2" onclick="editProject('${p.id}', ${currentFilter === 'deleted'})">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow overflow-hidden mr-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[8px] font-bold px-1.5 py-0.5 rounded shrink-0 ${getSourceClass(p.source)}">${p.source}</span>
                                <h3 class="font-bold text-sm text-gray-800 truncate">${p.shopName}</h3>
                            </div>
                            ${visitLabel}
                        </div>
                        <span class="status-pill shrink-0 ${STATUS_MAP[p.status]?.class || ''}">${STATUS_MAP[p.status]?.label || '不明'}</span>
                    </div>
                </div>
            `;
            }).join('');
            
            if (filtered.length === 0) container.innerHTML = `<p class="text-center text-white/30 text-xs py-10">該当する案件がありません</p>`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-title');
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            title.innerText = `${y}年 ${m + 1}月`;
            grid.innerHTML = '';
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m + 1, 0).getDate();
            for (let i = 0; i < first; i++) grid.innerHTML += `<div></div>`;
            for (let d = 1; d <= last; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const has = projects.some(p => p.visitDate?.startsWith(dateStr));
                grid.innerHTML += `
                    <div onclick="showDay('${dateStr}')" class="h-12 flex flex-col items-center justify-center rounded-xl hover:bg-black/5 active:bg-black/10">
                        <span class="text-xs font-bold text-gray-700">${d}</span>
                        ${has ? '<div class="w-1.5 h-1.5 bg-red-500 rounded-full mt-0.5"></div>' : ''}
                    </div>
                `;
            }
        }

        function showDay(date) {
            const list = projects.filter(p => p.visitDate?.startsWith(date));
            const container = document.getElementById('calendar-day-details');
            if (list.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = `<h4 class="text-white text-[10px] font-bold uppercase px-1 mt-4 mb-2">${date}</h4>` + list.map(p => `
                <div class="glass-card p-4 flex justify-between items-center mb-2" onclick="editProject('${p.id}')">
                    <div class="flex items-center gap-2">
                        <span class="text-[8px] font-bold px-1.5 py-0.5 rounded ${getSourceClass(p.source)}">${p.source}</span>
                        <span class="font-bold text-sm text-gray-800">${p.shopName}</span>
                    </div>
                    <span class="status-pill ${STATUS_MAP[p.status].class}">${STATUS_MAP[p.status].label}</span>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function openModal() {
            document.getElementById('pr-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('modal-title').innerText = '案件登録';
            document.getElementById('delete-btn').classList.add('hidden');
            document.getElementById('restore-btn').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
            document.querySelector('.modal-body').scrollTop = 0;
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function editProject(id, isDeleted = false) {
            const list = isDeleted ? deletedProjects : projects;
            const p = list.find(item => item.id === id);
            if (!p) return;
            openModal();
            document.getElementById('edit-id').value = p.id;
            document.getElementById('shop-name').value = p.shopName;
            document.getElementById('status').value = p.status;
            document.getElementById('visit-date').value = p.visitDate || '';
            document.getElementById('source').value = p.source;
            document.getElementById('notes').value = p.notes || '';
            document.querySelectorAll('input[name="todo"]').forEach(cb => cb.checked = (p.todos || []).includes(cb.value));
            document.querySelectorAll('input[name="condition"]').forEach(cb => cb.checked = (p.conditions || []).includes(cb.value));
            if (isDeleted) {
                document.getElementById('restore-btn').classList.remove('hidden');
                document.getElementById('delete-btn').classList.remove('hidden');
                document.getElementById('delete-btn').onclick = () => { if(confirm('完全に削除しますけ？')){ deletedProjects = deletedProjects.filter(x => x.id !== id); saveData(); closeModal(); } };
            } else {
                document.getElementById('delete-btn').classList.remove('hidden');
                document.getElementById('delete-btn').onclick = deleteToTrash;
            }
        }

        document.getElementById('pr-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value || Date.now().toString();
            const p = {
                id,
                shopName: document.getElementById('shop-name').value,
                status: document.getElementById('status').value,
                visitDate: document.getElementById('visit-date').value,
                source: document.getElementById('source').value,
                notes: document.getElementById('notes').value,
                todos: Array.from(document.querySelectorAll('input[name="todo"]:checked')).map(el => el.value),
                conditions: Array.from(document.querySelectorAll('input[name="condition"]:checked')).map(el => el.value)
            };
            const idx = projects.findIndex(item => item.id === id);
            if (idx > -1) projects[idx] = p; else projects.push(p);
            saveData();
            closeModal();
        };

        function deleteToTrash() {
            const id = document.getElementById('edit-id').value;
            const idx = projects.findIndex(p => p.id === id);
            if (idx === -1) return;
            deletedProjects.push(projects[idx]);
            projects.splice(idx, 1);
            saveData();
            closeModal();
        }

        function restoreFromTrash() {
            const id = document.getElementById('edit-id').value;
            const idx = deletedProjects.findIndex(p => p.id === id);
            if (idx === -1) return;
            projects.push(deletedProjects[idx]);
            deletedProjects.splice(idx, 1);
            saveData();
            closeModal();
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }
    </script>
</body>
</html>
